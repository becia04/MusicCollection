@{
    ViewBag.Title = "Dodaj";
}
<style>
    .selected-artists {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .selected-artist {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        padding: 5px 10px;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }

    .remove-artist {
        color: red;
        margin-left: 10px;
        cursor: pointer;
    }
</style>

<head>
    <title>Dodaj nowy album</title>
</head>
<h2>Dodaj nowy album</h2>
<form action="/Home/AddAlbum" method="post" enctype="multipart/form-data">
    <div style="display: flex; flex-direction: row;">
        <div style="margin-right: 20px;">
            <label for="title">Tytuł:</label><br>
            <input type="text" id="title" name="title" class="dropbtn" style="cursor:text;"><br><br>
        </div>
        <div style="margin-right: 20px;">
            <label for="publishDate">Rok publikacji:</label><br>
            <input type="number" id="publishDate" name="PublishDate" class="dropbtn" style="cursor:text;" min="1900" max="@DateTime.Now.Year"><br><br>
        </div>

        <div style="margin-right: 20px;">
            <label for="poster">Plakat:</label><br>
            <input type="file" id="poster" name="posterFile" accept=".jpg"><br><br>
        </div>
        <div style="margin-right: 20px;">
            <label for="type">Typ:</label><br>
            <select id="type" name="typeId" class="dropbtn">
                @foreach (var type in ViewBag.Types)
                {
                    <option value="@type.Id">@type.Name</option>
                }
            </select><br><br>
        </div>
        <div style="margin-right: 20px;">
            <label for="category">Gatunek:</label><br>
            <select id="category" name="categoryId" class="dropbtn">
                @foreach (var category in ViewBag.Categories)
                {
                    <option value="@category.Id">@category.Name</option>
                }
            </select><br><br>
        </div>
        <div>
            <label for="artist">Artysta:</label><br>
            <input type="text" name="artistName" id="artistName" oninput="suggestArtists(this)" class="dropbtn" style="cursor:text;" onchange="addNewArtist(this.value)">
            <button id="addNewArtistBtn" type="button" onclick="addNewArtistFromTextbox()" style="display: none; margin-left: 10px;">+</button>
            <input type="hidden" name="artistId" id="artistId">
            <div id="suggestions" class="suggestions"></div><br><br>
            <div id="selectedArtists" class="selected-artists"></div>
        </div>
    </div>

    <input type="submit" value="Dodaj album" class="dropbtn">
</form>

<script>
    function suggestArtists(input) {
        var suggestionsDiv = document.getElementById('suggestions');
        var inputValue = input.value;
        var addNewArtistBtn = document.getElementById('addNewArtistBtn');

        if (inputValue.length > 0) {
            fetch('/Home/GetArtistSuggestions?query=' + inputValue)
                .then(response => response.json())
                .then(data => {
                    suggestionsDiv.innerHTML = '';
                    if (data.length > 0) {
                        // Ukrywamy przycisk plus, jeśli są sugestie
                        addNewArtistBtn.style.display = 'none';
                        data.forEach(artist => {
                            var option = document.createElement('div');
                            option.textContent = artist.name;
                            option.onclick = function () {
                                addArtistToSelected(artist.name, artist.id);
                                input.value = '';  // Czyszczenie pola tekstowego
                                suggestionsDiv.innerHTML = '';
                            };
                            suggestionsDiv.appendChild(option);
                        });
                    } else {
                        // Pokaż przycisk plus, jeśli brak sugestii
                        addNewArtistBtn.style.display = 'inline';
                    }
                });
        } else {
            suggestionsDiv.innerHTML = '';
            addNewArtistBtn.style.display = 'none';
        }
    }

    function addNewArtistFromTextbox() {
        var input = document.getElementById('artistName');
        var artistName = input.value.trim();

        if (artistName.length > 0) {
            // Dodanie nowego artysty na liście wybranych
            addArtistToSelected(artistName, null);  // Dodajemy z `null`, ponieważ to nowy artysta
            input.value = '';  // Czyszczenie pola tekstowego
            document.getElementById('addNewArtistBtn').style.display = 'none';
        }
    }

    function addArtistToSelected(artistName, artistId) {
        var selectedArtistsDiv = document.getElementById('selectedArtists');

        // Tworzymy nowe pole z nazwą artysty
        var artistDiv = document.createElement('div');
        artistDiv.className = 'selected-artist';
        artistDiv.innerHTML = `
            ${artistName} <span class="remove-artist" onclick="removeArtist(this)">x</span>
            <input type="hidden" name="artistIds[]" value="${artistId || 'new-' + artistName}">
        `;

        selectedArtistsDiv.appendChild(artistDiv);
    }

    function removeArtist(element) {
        element.parentNode.remove();
    }


        // Pobierz aktualny rok
        var currentYear = new Date().getFullYear();

    // Ustaw maksymalny rok dla pola input
    document.getElementById("publishYear").setAttribute("max", currentYear);

</script>
